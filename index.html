<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LifeQuest - Gamified Achievement Tracker</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Feather Icons -->
    <script src="https://unpkg.com/feather-icons"></script>

    <!-- Canvas Confetti for Animations -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            dark: '#0f172a',
                            light: '#1e293b',
                            accent: '#10b981', // Emerald 500
                            accentGlow: '#34d399',
                            purple: '#8b5cf6'
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-out forwards',
                        'slide-up': 'slideUp 0.6s ease-out forwards',
                        'bounce-sm': 'bounceSmall 0.3s ease-in-out',
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        },
                        bounceSmall: {
                            '0%, 100%': { transform: 'scale(1)' },
                            '50%': { transform: 'scale(0.95)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #0f172a;
        }

        ::-webkit-scrollbar-thumb {
            background: #334155;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #475569;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .glass-card {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }

        /* Achievement Checkbox Animation */
        .checkbox-wrapper input:checked+div {
            background-color: #10b981;
            border-color: #10b981;
        }

        .checkbox-wrapper input:checked+div svg {
            transform: scale(1);
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.27, 1.55);
        }

        .toast.show {
            transform: translateX(0);
        }

        /* XP Progress Bar Animation */
        .progress-bar-fill {
            transition: width 1s ease-out;
        }
    </style>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, getDocs, deleteDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCeX6wm9yoExRXg7UFjtMXsTnjDvuq6xXU",
            authDomain: "lifequest-650c7.firebaseapp.com",
            projectId: "lifequest-650c7",
            storageBucket: "lifequest-650c7.firebasestorage.app",
            messagingSenderId: "748079636209",
            appId: "1:748079636209:web:e3f97d0e0033b799bf9350"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);























































        // Achievement Data
        const achievements = [
            { id: 'bedwetting', title: "Wet the bed", description: "A memorable nighttime accident.", icon: 'droplet' },
            { id: 'first_day_school', title: "First day of school", description: "Survived your first day of school.", icon: 'backpack' },
            { id: 'first_lost_tooth', title: "Lost your first tooth", description: "The tooth fairy has visited.", icon: 'tooth' },
            { id: 'first_lie', title: "First lie to an adult", description: "Told them the dog ate your homework.", icon: 'mask' },
            { id: 'first_10', title: "First A+", description: "A brilliant school achievement.", icon: 'trophy' },
            { id: 'failed_exam', title: "Failed an exam", description: "Not every plan works out.", icon: 'cry' },
            { id: 'forgot_homework', title: "Forgot homework at home", description: "The most classic excuse in history.", icon: 'brain' },
            { id: 'fell_asleep_class', title: "Fell asleep in class", description: "So focused you couldn’t keep your eyes open.", icon: 'sleep' },
            { id: 'copied_wrong', title: "Copied from the wrong classmate", description: "Both of you should have studied instead...", icon: 'eyes' },
            { id: 'first_kiss', title: "First kiss", description: "A kiss you’ll never forget.", icon: 'kiss' },
            { id: 'imaginary_friend', title: "Imaginary friend", description: "You had a friend only you could see.", icon: 'ghost' },
            { id: 'made_class_laugh', title: "Made the whole class laugh", description: "You were the class clown.", icon: 'laugh' },
            { id: 'called_wrong_person', title: "Called the wrong person", description: "Double embarrassment when you finally got the name right.", icon: 'people' },
            { id: 'flirted', title: "Flirted with someone", description: "A daring attempt at romance.", icon: 'smirk' },
            { id: 'pizza_breakfast', title: "Ate pizza for breakfast", description: "Because why not? It’s basically a savory cake.", icon: 'pizza' },
            { id: 'burned_water', title: "Burned the water", description: "So distracted you evaporated it all.", icon: 'fire' },
            { id: 'ordered_food_fell_asleep', title: "Ordered food and fell asleep", description: "The delivery person knocked in vain.", icon: 'bed' },
            { id: 'ate_expired_food', title: "Ate expired food", description: "The date is just a suggestion… right?", icon: 'calendar' },
            { id: 'forgot_password', title: "Forgot your password", description: "Once again…", icon: 'key' },
            { id: 'sent_wrong_message', title: "Sent the wrong message", description: "That 'I love you' was meant for mom, promise!", icon: 'phone' },
            { id: 'fell_while_phone', title: "Fell while looking at your phone", description: "The sidewalk was uneven, I swear!", icon: 'selfie' },
            { id: 'called_by_mistake', title: "Called someone by mistake", description: "Pocket panic strikes again.", icon: 'telephone' },
            { id: 'missed_flight_train', title: "Missed the flight/train", description: "Running didn’t help.", icon: 'plane' },
            { id: 'slept_at_airport', title: "Slept at the airport", description: "Uncomfortable bed, but adventurous.", icon: 'sleeping' },
            { id: 'visited_3_countries', title: "Visited 3 different countries", description: "Budding explorer.", icon: 'globe' },
            { id: 'ate_strange_food', title: "Accidentally ate weird food", description: "Was it horse? Pig? Ask later.", icon: 'meat' },
            { id: 'first_bill_paid', title: "First bill paid", description: "Welcome to adulthood.", icon: 'money' },
            { id: 'forgot_birthday', title: "Forgot a birthday", description: "Better late than never… right?", icon: 'cake' },
            { id: 'did_laundry', title: "Did the laundry", description: "Efficiency unlocked.", icon: 'socks' },
            { id: 'skydiving', title: "Skydived", description: "Flying without wings.", icon: 'parachute' },
            { id: 'ate_super_spicy', title: "Ate super spicy food", description: "Why did I do this?", icon: 'chili' },
            { id: 'walked_into_glass', title: "Walked into a clean glass", description: "Could happen to anyone… right?", icon: 'window' },
            { id: 'fell_down_stairs', title: "Fell down the stairs", description: "A faster descent than expected.", icon: 'chart-down' },
            { id: 'broke_bone', title: "Broke a bone", description: "You didn’t last long.", icon: 'bone' },
            { id: 'vomited_on_someone', title: "Vomit on someone", description: "Hit and sunk.", icon: 'vomit' },
            { id: 'got_drunk_memory_loss', title: "Got drunk and lost memory", description: "I’m fine, I swear!", icon: 'champagne' },
            { id: 'drunk', title: "Drunk.", description: "Get drunk, this alcohol tastes like piss.", icon: 'coffee' },
            { id: 'scratch_and_lose', title: "Scratch and lose.", description: "You lost on a scratch card, spend the money in a better way...", icon: 'dollar-sign' },
            { id: 'scratch_card', title: "Scratch Card.", description: "Win for the first time", icon: 'dollar-sign' },
            { id: 'first_beer', title: "First beer.", description: "Those shiny car keys are calling…", icon: 'moon' },
            { id: 'betray', title: "Betray.", description: "“This was all part of my plan.”", icon: 'target' },
            { id: 'betrayal', title: "Betrayal...", description: "“You will only be betrayed by a friend, never by an enemy.”", icon: 'shield' },
            { id: 'you_became_a_father', title: "You became a father.", description: "Mexico is looking good...", icon: 'heart' },
            { id: 'pregnant', title: "Pregnant", description: "You got pregnant! Congratulations...", icon: 'heart' },
            { id: 'read_book', title: 'Book Worm', description: 'Read a complete book', icon: 'book' },
            { id: 'workout', title: 'Fitness Fanatic', description: 'Complete a workout session', icon: 'activity' },
            { id: 'meditate', title: 'Zen Master', description: 'Meditate for 10 minutes', icon: 'moon' },
            { id: 'healthy_meal', title: 'Healthy Eater', description: 'Prepare a healthy meal', icon: 'coffee' },
            { id: 'early_rise', title: 'Early Bird', description: 'Wake up before 7 AM', icon: 'sunrise' },
            { id: 'no_social', title: 'Digital Detox', description: 'Avoid social media for a day', icon: 'wifi-off' },
            { id: 'learn_skill', title: 'Skill Hunter', description: 'Learn a new skill', icon: 'tool' },
            { id: 'gratitude', title: 'Thankful Heart', description: 'Write down 3 things you\'re grateful for', icon: 'heart' },
            { id: 'random_act', title: 'Kindness Warrior', description: 'Perform a random act of kindness', icon: 'smile' },
            { id: 'water', title: 'Hydration Hero', description: 'Drink 2L of water in a day', icon: 'droplet' }
        ];



















































        // DOM Elements
        const authContainer = document.getElementById('auth-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const logoutBtn = document.getElementById('logout-btn');
        const usernameDisplay = document.getElementById('username-display');
        const usernameEdit = document.getElementById('username-edit');
        const saveUsernameBtn = document.getElementById('save-username-btn');
        const achievementsContainer = document.getElementById('achievements-container');
        const friendUidInput = document.getElementById('friend-uid-input');
        const sendRequestBtn = document.getElementById('send-request-btn');
        const requestsContainer = document.getElementById('requests-container');
        const friendsContainer = document.getElementById('friends-container');
        const authError = document.getElementById('auth-error');
        const authSuccess = document.getElementById('auth-success');
        const xpFill = document.getElementById('xp-fill');
        const xpText = document.getElementById('xp-text');

        // Toast Notification System
        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');

            const bgClass = type === 'error' ? 'bg-red-500' : type === 'success' ? 'bg-brand-accent' : 'bg-blue-500';
            const icon = type === 'error' ? 'alert-circle' : type === 'success' ? 'check-circle' : 'info';

            toast.className = `toast glass-card text-white px-6 py-4 rounded-xl shadow-2xl flex items-center gap-3 ${bgClass}`;
            toast.innerHTML = `
                <i data-feather="${icon}" class="w-5 h-5"></i>
                <span class="font-medium">${message}</span>
            `;

            container.appendChild(toast);
            feather.replace();

            // Animate in
            requestAnimationFrame(() => {
                toast.classList.add('show');
            });

            // Remove after 3 seconds
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // Confetti Effect Helper
        function triggerConfetti() {
            const count = 200;
            const defaults = { origin: { y: 0.7 } };

            function fire(particleRatio, opts) {
                confetti(Object.assign({}, defaults, opts, {
                    particleCount: Math.floor(count * particleRatio)
                }));
            }

            fire(0.25, { spread: 26, startVelocity: 55 });
            fire(0.2, { spread: 60 });
            fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
            fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
            fire(0.1, { spread: 120, startVelocity: 45 });
        }

        // Check auth state
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authContainer.classList.add('opacity-0', 'pointer-events-none');
                setTimeout(() => {
                    authContainer.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                    // Trigger reflow
                    void appContainer.offsetWidth;
                    appContainer.classList.add('animate-fade-in');
                    setupRealtimeUpdates(user.uid);
                }, 500);
            } else {
                appContainer.classList.add('hidden');
                appContainer.classList.remove('animate-fade-in');
                authContainer.classList.remove('hidden', 'opacity-0', 'pointer-events-none');
                authContainer.classList.add('animate-fade-in');
            }
        });

        // Setup realtime listeners
        function setupRealtimeUpdates(userId) {
            // Initial load
            loadUserData(userId);

            // Realtime user data listener
            const userUnsub = onSnapshot(doc(db, "users", userId), (doc) => {
                if (doc.exists()) {
                    const userData = doc.data();
                    updateProfileUI(userData);
                    renderAchievements(userData.achievements || {});
                }
            });

            // Realtime friend requests listener
            const incomingQuery = query(
                collection(db, "friend_requests"),
                where("to", "==", userId),
                where("status", "==", "pending")
            );

            const outgoingQuery = query(
                collection(db, "friend_requests"),
                where("from", "==", userId),
                where("status", "==", "pending")
            );

            const incomingUnsub = onSnapshot(incomingQuery, async (snapshot) => {
                const incomingRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const outgoingSnapshot = await getDocs(outgoingQuery);
                const outgoingRequests = outgoingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRequests(incomingRequests, outgoingRequests);
            });

            const outgoingUnsub = onSnapshot(outgoingQuery, async (snapshot) => {
                const outgoingRequests = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const incomingSnapshot = await getDocs(incomingQuery);
                const incomingRequests = incomingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderRequests(incomingRequests, outgoingRequests);
            });

            // Realtime friends listener
            const friendsUnsub = onSnapshot(doc(db, "users", userId), (doc) => {
                if (doc.exists()) {
                    const userData = doc.data();
                    loadFriends(userId, userData.friends || []);
                }
            });

            return () => {
                userUnsub();
                incomingUnsub();
                outgoingUnsub();
                friendsUnsub();
            };
        }

        function updateProfileUI(userData) {
            const level = userData.level || 1;
            const xp = userData.xp || 0;
            const xpForNextLevel = 200;
            const currentLevelProgress = xp % xpForNextLevel;
            const progressPercent = (currentLevelProgress / xpForNextLevel) * 100;

            usernameDisplay.innerHTML = `${userData.username} <span class="text-brand-accent font-bold text-xl">Lvl ${level}</span>`;
            usernameEdit.value = userData.username;

            // Update XP Bar
            xpFill.style.width = `${progressPercent}%`;
            xpText.innerText = `${currentLevelProgress} / ${xpForNextLevel} XP`;
        }

        // Auth Handlers
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = loginForm['login-email'].value;
            const password = loginForm['login-password'].value;
            const btn = loginForm.querySelector('button');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<i data-feather="loader" class="animate-spin mx-auto"></i>';
            feather.replace();
            btn.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showToast('Welcome back, Hero!', 'success');
            } catch (error) {
                showToast(error.message, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
                feather.replace();
            }
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = registerForm['register-email'].value;
            const password = registerForm['register-password'].value;
            const btn = registerForm.querySelector('button');
            const originalText = btn.innerHTML;

            btn.innerHTML = '<i data-feather="loader" class="animate-spin mx-auto"></i>';
            feather.replace();
            btn.disabled = true;

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                const userId = userCredential.user.uid;

                await setDoc(doc(db, "users", userId), {
                    username: email.split('@')[0],
                    achievements: {},
                    friends: [],
                    xp: 0,
                    level: 1
                });

                showToast('Account created successfully!', 'success');
            } catch (error) {
                showToast(error.message, 'error');
                btn.innerHTML = originalText;
                btn.disabled = false;
                feather.replace();
            }
        });

        logoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
                showToast('Logged out successfully', 'info');
            } catch (error) {
                console.error('Logout error:', error);
            }
        });

        // Load initial data
        async function loadUserData(userId) {
            const userDoc = await getDoc(doc(db, "users", userId));
            if (userDoc.exists()) {
                const userData = userDoc.data();
                updateProfileUI(userData);
                document.getElementById('user-id-display').textContent = userId;

                const copyBtn = document.getElementById('copy-user-id');
                copyBtn.onclick = () => {
                    navigator.clipboard.writeText(userId);
                    showToast('User ID copied!', 'success');
                };

                renderAchievements(userData.achievements || {});

                // Initial Load for Friends/Requests
                const incomingQuery = query(collection(db, "friend_requests"), where("to", "==", userId), where("status", "==", "pending"));
                const outgoingQuery = query(collection(db, "friend_requests"), where("from", "==", userId), where("status", "==", "pending"));

                const [incomingSnapshot, outgoingSnapshot] = await Promise.all([
                    getDocs(incomingQuery),
                    getDocs(outgoingQuery)
                ]);

                renderRequests(
                    incomingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })),
                    outgoingSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
                );

                loadFriends(userId, userData.friends || []);
            }
        }

        // Render Achievements
        function renderAchievements(userAchievements) {
            // Note: We NO LONGER do achievementsContainer.innerHTML = ''
            // This prevents the list from "flashing" or refreshing every time.

            achievements.forEach((achievement) => {
                const cardId = `card-${achievement.id}`;
                const existingCard = document.getElementById(cardId);
                const isCompleted = userAchievements[achievement.id] || false;

                if (existingCard) {
                    // UPDATE EXISTING CARD (Smooth Update)
                    // Update Checkbox State
                    const checkbox = existingCard.querySelector('input[type="checkbox"]');
                    if (checkbox.checked !== isCompleted) {
                        checkbox.checked = isCompleted;
                    }

                    // Update Visual Styles (Classes)
                    if (isCompleted) {
                        existingCard.classList.add('border-brand-accent/50', 'bg-brand-accent/10');
                        existingCard.querySelector('h3').classList.add('text-brand-accent', 'line-through');
                        existingCard.querySelector('h3').classList.remove('text-gray-200');
                    } else {
                        existingCard.classList.remove('border-brand-accent/50', 'bg-brand-accent/10');
                        existingCard.querySelector('h3').classList.remove('text-brand-accent', 'line-through');
                        existingCard.querySelector('h3').classList.add('text-gray-200');
                    }
                } else {
                    // CREATE NEW CARD (Only runs if card doesn't exist yet)
                    const card = document.createElement('div');
                    card.id = cardId; // Important: Assign ID so we can find it later
                    card.className = `glass-card p-5 rounded-xl transition-all duration-300 transform hover:scale-[1.02] hover:shadow-xl border border-gray-700 group animate-slide-up opacity-0 fill-mode-forwards`;

                    card.innerHTML = `
                        <label class="flex items-start cursor-pointer relative checkbox-wrapper">
                            <input type="checkbox" class="hidden">
                            <div class="flex-shrink-0 w-6 h-6 rounded-md border-2 border-gray-500 flex items-center justify-center transition-colors mr-4 mt-1 group-hover:border-brand-accent">
                                <svg class="w-4 h-4 text-white transform scale-0 transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24"><polyline stroke-width="3" points="20 6 9 17 4 12"></polyline></svg>
                            </div>
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <h3 class="font-bold text-lg text-gray-200 transition-colors">${achievement.title}</h3>
                                    <i data-feather="${achievement.icon}" class="text-gray-500 group-hover:text-brand-accent transition-colors"></i>
                                </div>
                                <p class="text-sm text-gray-400 mt-1 transition-colors">${achievement.description}</p>
                                <div class="mt-2 text-xs font-bold text-gray-500 group-hover:text-brand-accent transition-colors">+50 XP</div>
                            </div>
                        </label>
                    `;

                    card.querySelector('input').addEventListener('change', async (e) => {
                        const newStatus = e.target.checked;
                        const userId = auth.currentUser.uid;

                        // 1. Get current user state to ensure math is correct
                        const userDoc = await getDoc(doc(db, "users", userId));
                        const data = userDoc.data();
                        const currentXP = data.xp || 0;
                        const currentLevel = data.level || 1;

                        // 2. Calculate XP Delta (+50 for check, -50 for uncheck)
                        const xpChange = newStatus ? 50 : -50;
                        let newXP = currentXP + xpChange;

                        // Safety: Don't let XP go below 0
                        if (newXP < 0) newXP = 0;

                        // 3. Calculate new level based on new XP
                        const newLevel = Math.floor(newXP / 200) + 1;

                        try {
                            const updates = {
                                [`achievements.${achievement.id}`]: newStatus,
                                xp: newXP,
                                level: newLevel
                            };

                            await updateDoc(doc(db, "users", userId), updates);

                            // Visual Feedback
                            if (newStatus) {
                                triggerConfetti();
                                if (newLevel > currentLevel) {
                                    showToast(`LEVEL UP! You are now Level ${newLevel}`, 'success');
                                    triggerConfetti(); // Extra confetti
                                } else {
                                    showToast('Achievement Complete! +50 XP', 'success');
                                }
                            } else {
                                showToast('Achievement removed. -50 XP', 'info');
                            }
                        } catch (error) {
                            console.error(error);
                            showToast('Error updating achievement', 'error');
                            // Revert UI if error
                            e.target.checked = !newStatus;
                        }
                    });

                    achievementsContainer.appendChild(card);
                }
            });
            feather.replace();
        }

        // Update Username
        saveUsernameBtn.addEventListener('click', async () => {
            const newUsername = usernameEdit.value.trim();
            const userId = auth.currentUser.uid;

            if (newUsername && newUsername.length >= 3) {
                const btn = document.getElementById('save-username-btn');
                btn.innerHTML = '<i data-feather="loader" class="animate-spin w-4 h-4"></i>';
                feather.replace();

                try {
                    await updateDoc(doc(db, "users", userId), { username: newUsername });
                    showToast('Username updated!', 'success');
                } catch (error) {
                    showToast('Error updating username', 'error');
                }
                btn.innerHTML = 'Save';
                feather.replace();
            } else {
                showToast('Username must be at least 3 characters', 'error');
            }
        });

        // Send Friend Request
        sendRequestBtn.addEventListener('click', async () => {
            const friendUid = friendUidInput.value.trim();
            const userId = auth.currentUser.uid;

            if (!friendUid) return showToast('Please enter a user ID', 'error');
            if (friendUid === userId) return showToast("You can't befriend yourself!", 'error');

            try {
                const friendDoc = await getDoc(doc(db, "users", friendUid));
                if (!friendDoc.exists()) return showToast('User not found', 'error');

                const requestsQuery = query(collection(db, "friend_requests"), where("from", "==", userId), where("to", "==", friendUid));
                const existingRequests = await getDocs(requestsQuery);
                if (!existingRequests.empty) return showToast('Request already sent', 'error');

                await addDoc(collection(db, "friend_requests"), { from: userId, to: friendUid, status: "pending" });
                showToast('Friend request sent!', 'success');
                friendUidInput.value = '';
            } catch (error) {
                showToast('Error sending request', 'error');
            }
        });

        // Render Friend Requests
        async function renderRequests(incoming, outgoing) {
            requestsContainer.innerHTML = '';

            if (incoming.length === 0 && outgoing.length === 0) {
                requestsContainer.innerHTML = `<div class="text-center py-4 text-gray-500 text-sm italic">No pending requests</div>`;
                return;
            }

            // Helper to render a request item
            const renderItem = async (request, isIncoming) => {
                const otherUserId = isIncoming ? request.from : request.to;
                const userDoc = await getDoc(doc(db, "users", otherUserId));
                const username = userDoc.exists() ? userDoc.data().username : 'Unknown';
                const userInitials = username.substring(0, 2).toUpperCase();

                const el = document.createElement('div');
                el.className = 'glass p-3 rounded-lg mb-2 flex items-center justify-between animate-fade-in';

                if (isIncoming) {
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-brand-purple flex items-center justify-center text-white font-bold text-sm shadow-lg">
                                ${userInitials}
                            </div>
                            <div>
                                <div class="font-bold text-gray-200">${username}</div>
                                <div class="text-xs text-brand-accent">Sent Request</div>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button class="accept-btn p-2 bg-green-500/20 hover:bg-green-500 text-green-400 hover:text-white rounded-lg transition-all" data-id="${request.id}" title="Accept">
                                <i data-feather="check" class="w-4 h-4"></i>
                            </button>
                            <button class="decline-btn p-2 bg-red-500/20 hover:bg-red-500 text-red-400 hover:text-white rounded-lg transition-all" data-id="${request.id}" title="Decline">
                                <i data-feather="x" class="w-4 h-4"></i>
                            </button>
                        </div>
                    `;

                    // Event Listeners
                    el.querySelector('.accept-btn').addEventListener('click', () => handleFriendRequest(request.id, 'accepted'));
                    el.querySelector('.decline-btn').addEventListener('click', () => handleFriendRequest(request.id, 'declined'));
                } else {
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gray-600 flex items-center justify-center text-white font-bold text-sm">
                                ${userInitials}
                            </div>
                            <div>
                                <div class="font-bold text-gray-200">To: ${username}</div>
                                <div class="text-xs text-gray-500">Pending</div>
                            </div>
                        </div>
                        <div class="text-xs text-gray-500 bg-gray-700 px-2 py-1 rounded">Sent</div>
                    `;
                }

                requestsContainer.appendChild(el);
            };

            // Render lists
            for (const req of incoming) await renderItem(req, true);
            for (const req of outgoing) await renderItem(req, false);

            feather.replace();
        }

        // Handle Request Response
        async function handleFriendRequest(requestId, action) {
            const userId = auth.currentUser.uid;
            try {
                const requestDoc = await getDoc(doc(db, "friend_requests", requestId));
                if (!requestDoc.exists()) return;
                const requestData = requestDoc.data();

                if (action === 'accepted') {
                    await updateDoc(doc(db, "friend_requests", requestId), { status: "accepted" });
                    await updateDoc(doc(db, "users", userId), { friends: arrayUnion(requestData.from) });
                    await updateDoc(doc(db, "users", requestData.from), { friends: arrayUnion(userId) });
                    showToast(`You are now friends!`, 'success');
                } else {
                    await deleteDoc(doc(db, "friend_requests", requestId));
                }
            } catch (error) {
                showToast('Error processing request', 'error');
            }
        }

        // Load Friends List
        async function loadFriends(userId, friendsList) {
            if (!friendsList.length) {
                friendsContainer.innerHTML = `<div class="text-center py-4 text-gray-500 text-sm">No friends yet. Add one!</div>`;
                return;
            }

            const friendDocs = await Promise.all(friendsList.map(id => getDoc(doc(db, "users", id))));
            friendsContainer.innerHTML = '';

            friendDocs.forEach((docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const initials = data.username.substring(0, 2).toUpperCase();

                    const el = document.createElement('div');
                    el.className = 'glass p-3 rounded-lg mb-2 flex items-center justify-between hover:bg-white/5 transition-colors cursor-pointer animate-fade-in group';
                    el.innerHTML = `
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-brand-purple to-blue-500 flex items-center justify-center text-white font-bold text-sm shadow-lg group-hover:scale-110 transition-transform">
                                ${initials}
                            </div>
                            <div>
                                <div class="font-bold text-gray-200 friend-name">${data.username}</div>
                                <div class="text-xs text-brand-accent">Lvl ${data.level || 1}</div>
                            </div>
                        </div>
                        <i data-feather="chevron-right" class="text-gray-500 group-hover:translate-x-1 transition-transform"></i>
                    `;

                    el.addEventListener('click', () => openFriendProfile(docSnap.id, data));
                    friendsContainer.appendChild(el);
                }
            });
            feather.replace();
        }

        // Friend Profile Modal
        function openFriendProfile(friendId, friendData) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4';
            modal.innerHTML = `
                <div class="absolute inset-0 bg-black/60 backdrop-blur-sm animate-fade-in" id="modal-backdrop"></div>
                <div class="bg-gray-800 w-full max-w-lg rounded-2xl shadow-2xl border border-gray-700 overflow-hidden transform transition-all scale-95 opacity-0 animate-slide-up relative z-10">
                    <div class="h-24 bg-gradient-to-r from-brand-purple to-brand-accent"></div>
                    <button class="close-modal absolute top-4 right-4 bg-black/20 hover:bg-black/40 text-white rounded-full p-2 transition">
                        <i data-feather="x" class="w-5 h-5"></i>
                    </button>
                    <div class="px-6 pb-6 -mt-12">
                        <div class="w-24 h-24 rounded-full border-4 border-gray-800 bg-gray-700 flex items-center justify-center text-3xl font-bold text-white mb-4 shadow-lg">
                            ${friendData.username.substring(0, 2).toUpperCase()}
                        </div>
                        <h2 class="text-2xl font-bold text-white">${friendData.username} <span class="text-brand-accent text-lg">Lvl ${friendData.level || 1}</span></h2>
                        
                        <div class="mt-6">
                            <h3 class="text-sm font-bold text-gray-400 uppercase tracking-wider mb-3">Achievements</h3>
                            <div class="space-y-2 max-h-60 overflow-y-auto pr-2 custom-scroll">
                                ${achievements.map(a => {
                const done = friendData.achievements?.[a.id];
                return `
                                        <div class="flex items-center justify-between p-2 rounded-lg ${done ? 'bg-green-900/20' : 'bg-gray-700/30'}">
                                            <span class="text-sm ${done ? 'text-green-400' : 'text-gray-400'}">${a.title}</span>
                                            <i data-feather="${done ? 'check' : 'circle'}" class="w-4 h-4 ${done ? 'text-green-500' : 'text-gray-600'}"></i>
                                        </div>
                                    `;
            }).join('')}
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            feather.replace();

            // Animate entry
            requestAnimationFrame(() => {
                modal.querySelector('div.transform').classList.remove('scale-95', 'opacity-0');
            });

            // Close handlers
            modal.querySelector('.close-modal').addEventListener('click', () => modal.remove());
            modal.querySelector('#modal-backdrop').addEventListener('click', () => modal.remove());
        }

        // Initialize Feather Icons
        feather.replace();
    </script>
</head>

<body class="bg-brand-dark text-white min-h-screen selection:bg-brand-accent selection:text-white overflow-x-hidden">

    <!-- Auth Container -->
    <div id="auth-container" class="flex items-center justify-center min-h-screen p-4 relative">
        <!-- Background Decor -->
        <div class="absolute top-0 left-0 w-full h-full overflow-hidden -z-10">
            <div
                class="absolute top-[-10%] right-[-5%] w-96 h-96 bg-brand-purple/20 rounded-full blur-3xl animate-pulse-slow">
            </div>
            <div class="absolute bottom-[-10%] left-[-5%] w-96 h-96 bg-brand-accent/10 rounded-full blur-3xl animate-pulse-slow"
                style="animation-delay: 1.5s;"></div>
        </div>

        <div class="w-full max-w-md glass-card p-8 rounded-2xl border-t border-gray-700 relative overflow-hidden">
            <div class="text-center mb-8">
                <div
                    class="inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-gradient-to-tr from-brand-accent to-emerald-700 shadow-lg shadow-brand-accent/20 mb-4 animate-bounce-sm">
                    <i data-feather="gamepad" class="w-8 h-8 text-white"></i>
                </div>
                <h1 class="text-3xl font-extrabold tracking-tight text-white mb-1">LifeQuest</h1>
                <p class="text-gray-400 text-sm">Level up your daily habits.</p>
            </div>

            <!-- Tabs -->
            <div class="flex p-1 bg-gray-900/50 rounded-lg mb-6">
                <button id="tab-login"
                    class="flex-1 py-2 text-sm font-semibold rounded-md bg-gray-700 text-white shadow transition-all"
                    onclick="switchAuth('login')">Login</button>
                <button id="tab-register"
                    class="flex-1 py-2 text-sm font-semibold rounded-md text-gray-400 hover:text-white transition-all"
                    onclick="switchAuth('register')">Register</button>
            </div>

            <div id="auth-error"
                class="hidden bg-red-500/10 border border-red-500/20 text-red-400 p-3 rounded-lg text-sm mb-4 animate-fade-in">
            </div>
            <div id="auth-success"
                class="hidden bg-green-500/10 border border-green-500/20 text-green-400 p-3 rounded-lg text-sm mb-4 animate-fade-in">
            </div>

            <!-- Login Form -->
            <form id="login-form" class="space-y-4 animate-fade-in">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Email</label>
                    <input type="email" id="login-email" required
                        class="w-full px-4 py-3 bg-gray-900/50 border border-gray-700 rounded-xl focus:ring-2 focus:ring-brand-accent focus:border-transparent transition-all text-white placeholder-gray-600"
                        placeholder="hero@example.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Password</label>
                    <input type="password" id="login-password" required
                        class="w-full px-4 py-3 bg-gray-900/50 border border-gray-700 rounded-xl focus:ring-2 focus:ring-brand-accent focus:border-transparent transition-all text-white placeholder-gray-600"
                        placeholder="••••••••">
                </div>
                <button type="submit"
                    class="w-full bg-gradient-to-r from-brand-accent to-emerald-600 hover:from-emerald-400 hover:to-emerald-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-emerald-500/20 transform hover:scale-[1.02] transition-all duration-200">
                    Start Quest
                </button>
            </form>

            <!-- Register Form (Hidden by default) -->
            <form id="register-form" class="space-y-4 hidden animate-fade-in">
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Email</label>
                    <input type="email" id="register-email" required
                        class="w-full px-4 py-3 bg-gray-900/50 border border-gray-700 rounded-xl focus:ring-2 focus:ring-brand-purple focus:border-transparent transition-all text-white placeholder-gray-600"
                        placeholder="hero@example.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 uppercase mb-1 ml-1">Password</label>
                    <input type="password" id="register-password" required
                        class="w-full px-4 py-3 bg-gray-900/50 border border-gray-700 rounded-xl focus:ring-2 focus:ring-brand-purple focus:border-transparent transition-all text-white placeholder-gray-600"
                        placeholder="••••••••">
                </div>
                <button type="submit"
                    class="w-full bg-gradient-to-r from-brand-purple to-blue-600 hover:from-purple-400 hover:to-blue-500 text-white font-bold py-3 px-4 rounded-xl shadow-lg shadow-purple-500/20 transform hover:scale-[1.02] transition-all duration-200">
                    Create Character
                </button>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="hidden max-w-7xl mx-auto px-4 py-6 md:py-8">

        <!-- Navbar -->
        <header class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4 animate-slide-up">
            <div class="flex items-center gap-3">
                <div class="bg-brand-accent p-2 rounded-lg shadow-lg shadow-brand-accent/20">
                    <i data-feather="zap" class="text-white w-5 h-5 fill-current"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold text-white leading-none">LifeQuest</h1>
                    <p class="text-xs text-gray-400 mt-1">Gamify your existence</p>
                </div>
            </div>

            <div class="flex items-center gap-4 glass px-4 py-2 rounded-full border border-gray-700">
                <div class="text-right hidden sm:block">
                    <div class="text-xs text-gray-400 font-bold uppercase">Logged in as</div>
                    <div id="username-display" class="text-sm font-bold text-white">Loading...</div>
                </div>
                <div class="w-8 h-8 rounded-full bg-gray-700 flex items-center justify-center text-white">
                    <i data-feather="user" class="w-4 h-4"></i>
                </div>
                <button id="logout-btn" class="text-gray-400 hover:text-red-400 transition-colors ml-2" title="Logout">
                    <i data-feather="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6 lg:gap-8">

            <!-- Left Sidebar (Profile & Social) -->
            <aside class="lg:col-span-4 space-y-6">

                <!-- Character Card -->
                <div class="glass-card p-6 rounded-2xl border border-gray-700 animate-slide-up"
                    style="animation-delay: 0.1s;">
                    <div class="flex justify-between items-start mb-6">
                        <h2 class="text-lg font-bold flex items-center gap-2">
                            <i data-feather="shield" class="text-brand-accent"></i> Profile Stats
                        </h2>
                        <div class="relative group">
                            <i data-feather="edit-2"
                                class="w-4 h-4 text-gray-500 cursor-pointer hover:text-white transition"
                                onclick="document.getElementById('username-edit-wrapper').classList.toggle('hidden')"></i>
                        </div>
                    </div>

                    <div id="username-edit-wrapper"
                        class="hidden mb-4 p-3 bg-gray-900 rounded-lg border border-gray-600 animate-fade-in">
                        <label class="text-xs text-gray-400 uppercase font-bold ml-1">Change Hero Name</label>
                        <div class="flex gap-2 mt-1">
                            <input type="text" id="username-edit"
                                class="flex-1 bg-gray-800 text-white text-sm px-3 py-2 rounded-lg border-none focus:ring-1 focus:ring-brand-accent">
                            <button id="save-username-btn"
                                class="bg-brand-accent hover:bg-emerald-400 text-white px-3 py-2 rounded-lg text-sm font-bold transition">
                                Save
                            </button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- XP Bar -->
                        <div>
                            <div class="flex justify-between text-sm mb-2">
                                <span class="text-gray-400">Experience</span>
                                <span id="xp-text" class="text-brand-accent font-mono font-bold">0 / 200 XP</span>
                            </div>
                            <div
                                class="h-4 bg-gray-900 rounded-full overflow-hidden border border-gray-800 shadow-inner">
                                <div id="xp-fill"
                                    class="h-full bg-gradient-to-r from-brand-accent to-blue-500 w-0 relative progress-bar-fill">
                                    <div class="absolute top-0 right-0 bottom-0 w-full bg-white/20 animate-pulse"></div>
                                </div>
                            </div>
                        </div>

                        <!-- User ID Copy -->
                        <div>
                            <label class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1 block">Share
                                your ID</label>
                            <div class="flex items-center bg-gray-900 border border-gray-700 rounded-lg p-2 group hover:border-brand-accent/50 transition-colors cursor-pointer"
                                id="copy-trigger">
                                <span id="user-id-display"
                                    class="text-xs font-mono text-gray-400 truncate flex-1">...</span>
                                <i data-feather="copy"
                                    class="w-4 h-4 text-gray-500 group-hover:text-brand-accent transition-colors ml-2"
                                    id="copy-user-id"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Friends Module -->
                <div class="glass-card p-6 rounded-2xl border border-gray-700 animate-slide-up"
                    style="animation-delay: 0.2s;">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2">
                        <i data-feather="users" class="text-brand-purple"></i> Party
                    </h2>

                    <!-- Add Friend -->
                    <div class="mb-6">
                        <label class="text-xs text-gray-500 font-bold uppercase tracking-wider mb-1 block">Invite
                            Member</label>
                        <div class="flex gap-0">
                            <input type="text" id="friend-uid-input" placeholder="User ID"
                                class="flex-1 bg-gray-900 border border-gray-700 border-r-0 rounded-l-lg px-4 py-2 text-sm focus:ring-1 focus:ring-brand-purple text-white">
                            <button id="send-request-btn"
                                class="bg-gray-700 hover:bg-brand-purple text-white px-3 py-2 rounded-r-lg border border-gray-700 border-l-0 transition-all">
                                <i data-feather="plus" class="w-4 h-4"></i>
                            </button>
                        </div>
                    </div>

                    <div class="space-y-6">
                        <!-- Requests -->
                        <div>
                            <h3
                                class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2 flex justify-between">
                                Requests <span class="bg-gray-700 text-gray-300 px-2 py-0.5 rounded-full text-[10px]"
                                    id="req-count">0</span>
                            </h3>
                            <div id="requests-container" class="space-y-1 max-h-40 overflow-y-auto pr-1">
                                <!-- JS Injected -->
                            </div>
                        </div>

                        <!-- Friends List -->
                        <div>
                            <h3 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-2">Members</h3>
                            <div id="friends-container" class="space-y-1 max-h-60 overflow-y-auto pr-1">
                                <!-- JS Injected -->
                            </div>
                        </div>
                    </div>
                </div>

            </aside>

            <!-- Main Content (Quest Board) -->
            <main class="lg:col-span-8">
                <div class="glass-card p-6 md:p-8 rounded-2xl border border-gray-700 min-h-[80vh] animate-slide-up"
                    style="animation-delay: 0.3s;">
                    <div class="flex items-center justify-between mb-8">
                        <h2 class="text-2xl font-bold flex items-center gap-3">
                            <i data-feather="target" class="text-brand-accent"></i> Daily Quests
                        </h2>
                        <div class="hidden md:block text-sm text-gray-400 bg-gray-800 px-3 py-1 rounded-lg">
                            <i data-feather="check-square" class="w-3 h-3 inline mr-1"></i> Complete tasks to gain XP
                        </div>
                    </div>

                    <div id="achievements-container" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <!-- JS Injected -->
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <!-- Scripts for UI Logic -->
    <script>
        // Tab Switcher
        function switchAuth(type) {
            const loginForm = document.getElementById('login-form');
            const regForm = document.getElementById('register-form');
            const loginTab = document.getElementById('tab-login');
            const regTab = document.getElementById('tab-register');
            const error = document.getElementById('auth-error');
            const success = document.getElementById('auth-success');

            // Hide messages
            error.classList.add('hidden');
            success.classList.add('hidden');

            if (type === 'login') {
                loginForm.classList.remove('hidden');
                regForm.classList.add('hidden');

                loginTab.classList.add('bg-gray-700', 'text-white', 'shadow');
                loginTab.classList.remove('text-gray-400');

                regTab.classList.remove('bg-gray-700', 'text-white', 'shadow');
                regTab.classList.add('text-gray-400');
            } else {
                loginForm.classList.add('hidden');
                regForm.classList.remove('hidden');

                regTab.classList.add('bg-gray-700', 'text-white', 'shadow');
                regTab.classList.remove('text-gray-400');

                loginTab.classList.remove('bg-gray-700', 'text-white', 'shadow');
                loginTab.classList.add('text-gray-400');
            }
        }

        // Copy ID logic
        document.getElementById('copy-trigger').addEventListener('click', () => {
            const btn = document.getElementById('copy-user-id');
            // Trigger click event attached by module logic or handle simply here
            btn.click();
        });

        // Initialize icons on load
        feather.replace();
    </script>
</body>

</html>
